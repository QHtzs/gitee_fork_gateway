# 数据交换服务系统
## 结构
* `WEB` TCP服务端：端口号自己配置
* `APP` TCP服务端: 端口号自己配置
* `GATEWay` TCP服务端:端口号自己配置
* `Redis`，用于保存控制信息实时状态(目前只监控GATEWay服务与客户端tcp连接状况)--2019/10.16取消启用
* `http客户端`，`WEB`,`APP`接入时触发，当前serial接入状况传输到指定http服务。
* `WebSocket` Web Socket服务，为了便于支持其他双工交互，开放了ws服务

## 大致通讯内容
### Tcp及Ws交互过程
* 1接收到新的连接
* 2委托其他routine检测序列号(防阻塞)，若不合法，则断开连接。
* 3发送确认消息(Accept)
* 4仅Tcp:获取序列号相同的tcp在分别WEB, APP三个服务的连接情况,并发送到指定的http服务及GateWay。
* 5正常数据交互及数据转发(所有连接的数据都传输给GateWay, GateWay有效数据广播到所有连接到服务--tcp,udp, ws的客户端)
* 6断开连接, tcp连接允许被挤下(GateWay则serial同会被挤下，web,app则需要serial + remoteAddress被挤下).<br>
若为tcp，则重复4一次。 最后结束该会话routine(有些会有少量时间延时)。


## GATEWay通讯中的加密解密
* 由于加密解密过程中，使用了base64，长度不为3的倍数时，粘包时可能会导解密失败
* 而通讯过程中，发现 '&nbsp;' (ascii码32)对数据解析过程不产生任何影响
* 针对上述情况，对于不为3的倍数的字符，加密前填充'&nbsp;'
* 解密后，去掉左边空白，再根据拆分明文包(目前只是粗略的通过{}判断，<br>
以‘{’开始，当‘}’构成闭合时结束， 如：{}, {{}}, ...)
* 字符串比对时请去掉开头结尾的空白

## 实时数据监控
* 如客户端一样，连接到服务
* serial为 MONITOR_${tcpserial},其中`tcpserial`为被监控客户端serial
* 一个serial只允许被一个MONITOR监听
* 允许被挤，若之前monitor连接存在，需要先挤下之前连接，再重新连接

## 资源消耗
* 该服务设计是针对平稳状态设计的，也就是多个长连接连在服务器，
某段时间的数量变化很少
* 故线程池，内存池均倾向只开拓不回收。
* 长连接较多，但是数据交互不频繁、数据量较少，故对cpu压力不大
* 当长连接变化较大时: 
* * 连接数突然增大，已开辟内存池不够时则会一直拓展<br>
* * 连接数骤然减小, 则内存不会立刻释放。
需要其内部触发一定机制时才缓慢把一些资源交给gc<br>

## 连接响应
* 客户端和服务端在同一台pc时，3000tcp长连接可以10秒内认证处理完毕。
* 数据广播，短数据(<128bytes)由GateWay广播到到2tcp,且客户端接到数据，
总费时低于2秒/1000次.





